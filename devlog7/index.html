<!DOCTYPE html>
<html lang="en">
<head>
    <title>Devlog #7: custom async runtime</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A deep dive into implementing an async runtime for my game engine."/>
    <meta name="author" content="Dom Williams">
    <!--<meta name="keywords" content="rust, gamedev, devlog, name-needed, game-engine, async, await, activity, ai, behavior, runtime, executor"/>-->
    <style type="text/css">:root{font-family:"Helvetica Neue",system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;color:#333;background-color:#fefefe;text-rendering:optimizeLegibility;font-size:13pt}body{max-width:38rem;padding:1rem;margin:auto}video{max-width:35rem;margin:auto;display:block}pre{padding:5px;border-radius:8px;overflow:auto}code{overflow:scroll;overflow-y:auto;overflow-x:auto;font-family:monospace;font-size:smaller;-webkit-font-feature-settings:normal;-moz-font-feature-settings:normal;font-feature-settings:normal;padding:1.5px;border-radius:4px;font-weight:400;background:#ececee}pre code{background:none !important;color:#444;margin:0;padding:0;line-height:1.1em}article{line-height:1.3rem;display:block;padding-top:.5rem}blockquote{border-left:2px solid;margin:40px 15px;padding:10px;font-style:italic}@media(max-width:683px){blockquote{margin:10px;padding:10px}}blockquote:before{content:"‚Äù";font-family:Georgia,serif;font-size:3.875rem;position:absolute;left:-40px;top:-20px}blockquote p:first-of-type{margin-top:0}blockquote p:last-of-type{margin-bottom:0}.article-date{color:#777;margin-bottom:20px}main header{margin:0}main header h1{margin-bottom:0}.article-title{font-size:2rem}.prev-next{width:100%}.next{float:right}nav#toc ul{list-style-type:disc;padding-left:10px;margin-left:10px}#toc{float:right;margin:0 1.5rem;background-color:#fafafa;padding:.5rem .5rem;border-radius:4px;line-height:1.5rem}#toc a,#toc a:visited{color:#0679a7}@media(max-width:500px){#toc{float:none;margin:auto;width:70%}.header-nav{display:block !important;float:none !important;text-align:center}}#blog-header{border-bottom:2px solid #333;margin:0 auto 5px;display:block;overflow:hidden}#blog-header h1{font-size:1.6rem}#blog-header nav{float:right}.link5eva a:visited,.link5eva a{color:var(--color)}#blog-header a{text-decoration:none;display:inline-block}#blog-header a:hover{color:#414141}.header-nav{display:inline;margin:auto;padding:.5rem 0}.icons svg{width:1rem;height:auto;padding:0 10px;color:#111}.footnote,.footnote p{font-size:.9em;font-style:italic;line-height:1.4}.footnote{font-style:normal}sup{vertical-align:super;line-height:0;font-size:.83em;padding:.1em .2em}.img_container{height:auto;display:block !important}.img_container img{display:inline-block;max-width:90%}.img_caption{text-align:left;font-size:.9em;font-style:italic}.hidden{display:none}#intro p,#intro li{font-size:.9rem}footer p{margin-top:0;font-size:.8rem;text-align:center;color:#5e5e5e}.note-aside:before{content:"Sidenote: ";font-weight:bold}.note-info{background-color:#dff0d8;border-color:#daf7cd}aside{border-width:1px;border-style:double;border-radius:10px;padding:.1rem .5rem;font-size:.9rem;background-color:#d3e9f5;border-color:#bde6fc}</style>
</head>

<body>
<header id="blog-header">
    <div class="link5eva">
        <h1 class="notalink header-nav"><a href="/" title="Return to root">Dom Williams</a></h1>
        <nav class="icons header-nav">
            <a href="/index.xml" title="RSS feed">
                <span class="hidden">RSS</span>
                <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title>
                    <path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/>
                </svg>
            </a>
            <a href="https://github.com/DomWilliams0" title="GitHub">
                <span class="hidden">GitHub</span>
                <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title>
                    <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
                </svg>
            </a>
            <a href="mailto:contact@domwillia.ms" title="Contact Me">
                <span class="hidden">Email</span>
                <!-- icon from Font Awesome: https://fontawesome.com/license-->
                <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="envelope"
                     class="svg-inline--fa fa-envelope fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg"
                     viewBox="0 0 512 512">
                    <path fill="currentColor"
                          d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
                </svg>

            </a>
        </nav>
    </div>
</header>

<main>
    <header>
        <h1 class="article-title">Devlog #7: custom async runtime</h1>
        <div class="article-date">
            <time datetime="2022-02-15">15 Feb 2022</time>
        </div>
    </header>
<aside class="note-info">
    This post is about my long-term Rust gamedev project, <a href="https://github.com/DomWilliams0/name-needed">Name Needed</a>. Yes, it needs a name.
</aside>

    <article>
        <nav id="toc" class="link5eva">
            <strong>Table of Contents</strong>
            <div class="toc">
<ul>
<li><a href="#some-definitions">Some definitions</a></li>
<li><a href="#custom-futures-executor">Custom futures executor</a><ul>
<li><a href="#task-references">Task references</a><ul>
<li><a href="#in-the-agent">In the agent</a></li>
<li><a href="#in-the-future-itself">In the future itself</a></li>
<li><a href="#in-the-runtime">In the runtime</a></li>
<li><a href="#in-a-scheduled-timer">In a scheduled timer</a></li>
</ul>
</li>
<li><a href="#polling-tasks">Polling tasks</a><ul>
<li><a href="#getting-a-waker">Getting a waker</a></li>
<li><a href="#runtime-references">Runtime references</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#using-the-runtime">Using the runtime</a><ul>
<li><a href="#events">Events</a></li>
<li><a href="#timers">Timers</a></li>
<li><a href="#interruptions">Interruptions</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>

        </nav>

        <p><a href="/devlog6">The last devlog</a> saw a large refactor of the entity activity system, to make use of
Rust's elegant <code>async</code>/<code>await</code> language features, instead of badly implementing them by hand. </p>
<p>The main challenge here is implementing a custom async runtime that drives futures in a way that
integrates into a game engine's architecture.  This post goes into the details of my implementation
and the design decisions behind it.</p>
<h1 id="some-definitions">Some definitions</h1>
<p>There are some terms and concepts to define early on, to ensure this post doesn't end up a thick
jargony mess.</p>
<ul>
<li>
<p><strong>Future</strong>: a computation that completes asynchronously. In the context of the game this means its
    execution takes place over many game ticks.</p>
</li>
<li>
<p><strong>Activity</strong>: a living entity's current behaviour, such as "go here" or "go pick up that item". Each
    instance of an activity is represented by a <strong>future</strong>, as these behaviours take time to
    complete (as covered in <a href="/devlog4">a previous devlog</a>).</p>
</li>
<li>
<p><strong>Task</strong>: a reference-counted allocation that holds a <strong>future</strong>'s state while it executes, and
    its result (success, cancelled, failed, etc) when it finishes. A task is <strong>ready</strong> when it has
    work it can do (such as searching for an item to pick up), or otherwise <strong>pending</strong> when it is
    waiting for an event until it can make progress (such as notification that the item was picked up
    successfully).<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup></p>
</li>
<li>
<p><strong>Runtime</strong>: central coordinator and executor of tasks, responsible for polling those that are
    ready each game tick. Unlike normal async executors, it does not spawn any worker threads for
    computation, but rather polls futures in serial on the main game thread. This is what allows us to
    use <code>Rc</code>s instead of marginally more expensive <code>Arc</code>s.</p>
</li>
</ul>
<p>These concepts can be summarised by the following Rust types, which are loosely based on
<a href="https://github.com/DomWilliams0/name-needed/blob/4d4f9cc45d14c4702318ddf51ee7f221a93ebe26/game/simulation/src/runtime/runtime.rs#L21">reality</a>. By the end of this post these should be clear.</p>
<p><a id="types"/></p>
<div class="code" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #204a87; font-weight: bold">struct</span> <span style="color: #000000">Runtime</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">Rc</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">RefCell</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">RuntimeInner</span><span style="color: #ce5c00; font-weight: bold">&gt;&gt;</span><span style="color: #000000; font-weight: bold">);</span><span style="color: #f8f8f8"></span>
<span style="color: #204a87; font-weight: bold">struct</span> <span style="color: #000000">RuntimeInner</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">ready_tasks</span>: <span style="color: #204a87">Vec</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">WeakTaskRef</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">type</span> <span style="color: #000000">TaskOutput</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #204a87">Result</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000; font-weight: bold">(),</span><span style="color: #f8f8f8"> </span><span style="color: #204a87">Box</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #204a87; font-weight: bold">dyn</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Error</span><span style="color: #ce5c00; font-weight: bold">&gt;&gt;</span><span style="color: #000000; font-weight: bold">;</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Runtime</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">spawn</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #000000">future</span>: <span style="color: #000000">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Future</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">Output</span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #000000">TaskOutput</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span>-&gt; <span style="color: #000000">TaskRef</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">tick</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">mark_ready</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #000000">task</span>: <span style="color: #000000">TaskRef</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">struct</span> <span style="color: #000000">TaskRef</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">std</span>::<span style="color: #000000">rc</span>::<span style="color: #000000">Rc</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">Task</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">);</span><span style="color: #f8f8f8"></span>
<span style="color: #204a87; font-weight: bold">struct</span> <span style="color: #000000">WeakTaskRef</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">std</span>::<span style="color: #000000">rc</span>::<span style="color: #000000">Weak</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">Task</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">);</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">struct</span> <span style="color: #000000">Task</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">runtime</span>: <span style="color: #000000">Runtime</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">future</span>: <span style="color: #000000">TaskFuture</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">event_sink</span>: <span style="color: #000000">VecDeque</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">EntityEvent</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">enum</span> <span style="color: #000000">TaskFuture</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">Running</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">futures</span>::<span style="color: #000000">future</span>::<span style="color: #000000">LocalBoxFuture</span><span style="color: #ce5c00; font-weight: bold">&lt;&#39;</span><span style="color: #204a87">static</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #000000">TaskOutput</span><span style="color: #ce5c00; font-weight: bold">&gt;&gt;</span><span style="color: #000000; font-weight: bold">),</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">Done</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">TaskOutput</span><span style="color: #000000; font-weight: bold">),</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">Cancelled</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">TaskRef</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">poll</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">mark_ready</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">cancel</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #8f5902; font-style: italic">/// Each living entity has one of these</span>
<span style="color: #204a87; font-weight: bold">struct</span> <span style="color: #000000">ActivityComponent</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">current</span>: <span style="color: #000000">TaskRef</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
</code></pre></div>

<h1 id="custom-futures-executor">Custom futures executor</h1>
<p><a href="/devlog6#the-way-of-async">As we've seen before</a>, writing activities with futures is nice and
ergonomic, but they need to be polled in order to be of any actual use. This requires a custom executor to
be integrated into the game engine.</p>
<p>The hardest bit was getting my head around the concepts of a runtime, tasks and futures, and
how they relate to each other in terms of ownership. The <a href="https://rust-lang.github.io/async-book/02_execution/04_executor.html">official async book</a> was really helpful here.</p>
<h2 id="task-references">Task references</h2>
<p>The core concept for a runtime is <strong>tasks</strong> - where do they live, and who owns them? </p>
<p>I showed <a href="#types">above</a> in the type definitions that it's typically <code>TaskRef</code>s and <code>WeakTaskRef</code>s
(reference-counted immutable <code>Task</code>s, strong and weak respectively) that are passed around rather than <code>Task</code>s
themselves.</p>
<p>Runtimes normally need to use <code>Arc</code>s and some kind of locking here because they conventionally
spread tasks across multiple threads. In this specialised single-threaded runtime we can skip the
costs of atomics and use <code>Rc</code>s and <code>RefCell</code>s, but in order to do that we need to convince the
compiler with a few incantations.</p>
<div class="code" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #8f5902; font-style: italic">// everything will run on the main thread</span>
<span style="color: #204a87; font-weight: bold">unsafe</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #204a87">Send</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">for</span><span style="color: #f8f8f8"> </span><span style="color: #000000">TaskRef</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{}</span><span style="color: #f8f8f8"></span>
<span style="color: #204a87; font-weight: bold">unsafe</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #204a87">Sync</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">for</span><span style="color: #f8f8f8"> </span><span style="color: #000000">TaskRef</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{}</span><span style="color: #f8f8f8"></span>
<span style="color: #204a87; font-weight: bold">unsafe</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #204a87">Send</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">for</span><span style="color: #f8f8f8"> </span><span style="color: #000000">WeakTaskRef</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{}</span><span style="color: #f8f8f8"></span>
<span style="color: #204a87; font-weight: bold">unsafe</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #204a87">Sync</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">for</span><span style="color: #f8f8f8"> </span><span style="color: #000000">WeakTaskRef</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{}</span><span style="color: #f8f8f8"></span>
</code></pre></div>

<p>Whether we use a strong or weak task reference depends on its usage, of which there are several:</p>
<h4 id="in-the-agent">In the agent</h4>
<p>This is the main use for a strong, owned task reference, because conceptually the agent owns the
task for as long as it is doing the behaviour. As the game engine follows the <a href="https://en.wikipedia.org/wiki/Entity_component_system">ECS
architecture</a>, this is stored in the
<a href="https://github.com/DomWilliams0/name-needed/blob/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/activity/system.rs#L27"><code>ActivityComponent</code></a>.</p>
<p>When it changes its mind and starts a new activity, dropping the old one should also drop the
underlying <code>Task</code> and future, regardless of any other references.</p>
<h4 id="in-the-future-itself">In the future itself</h4>
<p>As we'll see below, it takes a <code>TaskRef</code> in order to subscribe to events and timers. As these
requests need to be issued from within an activity (and therefore within a task), the activity needs
a reference to its owning task. </p>
<p><code>Rc</code>s make it easy to create cyclic references like this, but you need to be careful of how they are
dropped, otherwise you can cause memory leaks where the strong reference count can never drop to 0. We'll see later
how this isn't a problem for this situation.</p>
<h5 id="runtime-spawn">Runtime::spawn</h5>
<p>Due to the requirement that all tasks unconditionally need a self reference, the runtime's <code>spawn</code>
method makes use of a channel to pass it through to the future. </p>
<div class="code" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Runtime</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">pub</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">spawn</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #204a87; font-weight: bold">mut</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="background-color: #ffffcc"><span style="color: #f8f8f8">        </span><span style="color: #000000">gimme_task_ref</span>: <span style="color: #000000">futures</span>::<span style="color: #000000">channel</span>::<span style="color: #000000">oneshot</span>::<span style="color: #000000">Sender</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">TaskRef</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
</span><span style="color: #f8f8f8">        </span><span style="color: #000000">future</span>: <span style="color: #000000">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Future</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">Output</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">BoxedResult</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000; font-weight: bold">()</span><span style="color: #ce5c00; font-weight: bold">&gt;&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">+</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">&#39;</span><span style="color: #204a87">static</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span>-&gt; <span style="color: #000000">TaskRef</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #8f5902; font-style: italic">// allocate task ref</span>
<span style="color: #f8f8f8">        </span><span style="color: #204a87; font-weight: bold">let</span><span style="color: #f8f8f8"> </span><span style="color: #000000">task_ref</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">TaskRef</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">Rc</span>::<span style="color: #000000">new</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">Task</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #000000">future</span>: <span style="color: #000000">RefCell</span>::<span style="color: #000000">new</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">TaskFuture</span>::<span style="color: #000000">Running</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">future</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">boxed_local</span><span style="color: #000000; font-weight: bold">())),</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #000000; font-weight: bold">}));</span><span style="color: #f8f8f8"></span>

<span style="background-color: #ffffcc"><span style="color: #f8f8f8">        </span><span style="color: #8f5902; font-style: italic">// send a strong copy to the future for cyclic reference</span>
</span><span style="background-color: #ffffcc"><span style="color: #f8f8f8">        </span><span style="color: #204a87; font-weight: bold">let</span><span style="color: #f8f8f8"> </span><span style="color: #000000">_</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">gimme_task_ref</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">send</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">task_ref</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">clone</span><span style="color: #000000; font-weight: bold">());</span><span style="color: #f8f8f8"></span>
</span>
<span style="color: #f8f8f8">        </span><span style="color: #8f5902; font-style: italic">// task is ready immediately</span>
<span style="color: #f8f8f8">        </span><span style="color: #000000">runtime</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">ready</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">push</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">task_ref</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">weak</span><span style="color: #000000; font-weight: bold">());</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #000000">task</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #8f5902; font-style: italic">// elsewhere, when starting a new activity</span>
<span style="color: #204a87; font-weight: bold">let</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">taskref_tx</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #000000">taskref_rx</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">futures</span>::<span style="color: #000000">channel</span>::<span style="color: #000000">oneshot</span>::<span style="color: #000000">channel</span><span style="color: #000000; font-weight: bold">();</span><span style="color: #f8f8f8"></span>
<span style="color: #204a87; font-weight: bold">let</span><span style="color: #f8f8f8"> </span><span style="color: #000000">task_ref</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">runtime</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">spawn</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">taskref_tx</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">async</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">move</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="background-color: #ffffcc"><span style="color: #f8f8f8">    </span><span style="color: #8f5902; font-style: italic">// recv task ref from runtime</span>
</span><span style="background-color: #ffffcc"><span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">let</span><span style="color: #f8f8f8"> </span><span style="color: #000000">task</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">taskref_rx</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #204a87; font-weight: bold">await</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">unwrap</span><span style="color: #000000; font-weight: bold">();</span><span style="color: #f8f8f8"> </span><span style="color: #8f5902; font-style: italic">// sent unconditionally</span>
</span>
<span style="color: #f8f8f8">    </span><span style="color: #8f5902; font-style: italic">// create context for activity</span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">let</span><span style="color: #f8f8f8"> </span><span style="color: #000000">ctx</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">ActivityContext</span>::<span style="color: #000000">new</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #000000">task</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">);</span><span style="color: #f8f8f8"></span>

<span style="color: #f8f8f8">    </span><span style="color: #8f5902; font-style: italic">// execute the activity to completion</span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">new_activity</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">dew_it</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #000000">ctx</span><span style="color: #000000; font-weight: bold">).</span><span style="color: #204a87; font-weight: bold">await</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">});</span><span style="color: #f8f8f8"></span>
</code></pre></div>

<p>The runtime takes the sending half of a one-shot channel, and sends the newly created task reference
down immediately before the future has yet had a chance to polled. In <code>futures</code>' <a href="https://docs.rs/futures-channel/0.3.21/src/futures_channel/oneshot.rs.html#105">current
implementation</a> this
stores the <code>TaskRef</code> in an <code>Arc</code>.</p>
<p>A little later when the runtime polls all ready tasks, the task reference is read from the
channel/<code>Arc</code> and is stored in an <code>ActivityContext</code>. With this the activity can use events and timers.</p>
<h4 id="in-the-runtime">In the runtime</h4>
<p>The main responsibility of the runtime is to poll tasks that are ready for execution. The reasons a
task might be ready are that it's just been created, a timer has elapsed or an event has arrived.</p>
<p>A weak reference to the task is stored in the ready queue, which is processed each game tick. Only a
weak reference is needed here because there is no need to poll a task if the executing agent has
dropped the single owning reference; we don't care to make any more progress on it<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>.</p>
<h4 id="in-a-scheduled-timer">In a scheduled timer</h4>
<p><a href="https://github.com/DomWilliams0/name-needed/blob/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/event/timer.rs#L11-L15">A timer</a>
is also associated with a weak task reference. When it elapses after the specified number of game
ticks, <a href="https://github.com/DomWilliams0/name-needed/blob/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/runtime/system.rs#L24-L34">the task is marked as ready</a>
by pushing it onto the runtime's ready queue if the strong reference is still alive.</p>
<h2 id="polling-tasks">Polling tasks</h2>
<p>As we've seen, the runtime holds a list of ready tasks. Each game tick we call <code>Runtime::tick</code> to
<strong>poll</strong> these futures on the main game thread, allowing them to make progress.</p>
<p>The interface for polling a future is defined in the
<a href="https://doc.rust-lang.org/std/future/trait.Future.html">std::future::Future</a> trait, which looks
like the following:</p>
<div class="code" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #204a87; font-weight: bold">pub</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">trait</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Future</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">type</span> <span style="color: #000000">Output</span><span style="color: #000000; font-weight: bold">;</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">poll</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #3465a4">self</span>: <span style="color: #000000">Pin</span><span style="color: #ce5c00; font-weight: bold">&lt;&amp;</span><span style="color: #204a87; font-weight: bold">mut</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">Self</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #000000">cx</span>: <span style="color: #204a87; font-weight: bold">&amp;</span><span style="color: #000000">mut</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Context</span><span style="color: #ce5c00; font-weight: bold">&lt;&#39;</span><span style="color: #204a87">_</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span>-&gt; <span style="color: #000000">Poll</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #3465a4">Self</span>::<span style="color: #000000">Output</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">;</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">pub</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">enum</span> <span style="color: #000000">Poll</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">T</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">Ready</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">T</span><span style="color: #000000; font-weight: bold">),</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">Pending</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
</code></pre></div>

<h3 id="getting-a-waker">Getting a waker</h3>
<p>Something to note here is the <code>Context</code> reference we need to pass in, but where does this come from?
The <a href="https://doc.rust-lang.org/std/task/struct.Context.html">docs</a> show it holds a
<a href="https://doc.rust-lang.org/std/task/struct.Waker.html"><code>Waker</code></a> which needs a
<a href="https://doc.rust-lang.org/std/task/struct.RawWaker.html"><code>RawWaker</code></a>, which needs a very <code>unsafe</code>
<a href="https://doc.rust-lang.org/std/task/struct.RawWakerVTable.html">vtable</a>...</p>
<p>Luckily the handy <a href="https://github.com/Lucretiel/cooked-waker">cooked-waker</a> crate makes this very
easy for tasks that use Rust's standard pointer types like <code>Rc</code> and <code>Arc</code>. Integrating this with our
task types now only requires some simple
<a href="https://github.com/DomWilliams0/name-needed/blob/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/runtime/runtime.rs#L324-L342">glue</a>
to mark a task as ready in our own runtime, and to convert between raw pointers and <code>TaskRef</code>s:</p>
<div class="code" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">WakeRef</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">for</span><span style="color: #f8f8f8"> </span><span style="color: #000000">TaskRef</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">wake_by_ref</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #0000cf; font-weight: bold">0.</span><span style="color: #000000">runtime</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">mark_ready</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">);</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Wake</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">for</span><span style="color: #f8f8f8"> </span><span style="color: #000000">TaskRef</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{}</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">unsafe</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">ViaRawPointer</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">for</span><span style="color: #f8f8f8"> </span><span style="color: #000000">TaskRef</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">type</span> <span style="color: #000000">Target</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Task</span><span style="color: #000000; font-weight: bold">;</span><span style="color: #f8f8f8"></span>

<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">into_raw</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span>-&gt; <span style="color: #ce5c00; font-weight: bold">*</span><span style="color: #204a87; font-weight: bold">mut</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Task</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #000000">Rc</span>::<span style="color: #000000">into_raw</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #0000cf; font-weight: bold">0</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">as</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">*</span><span style="color: #204a87; font-weight: bold">mut</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Task</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">unsafe</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">from_raw</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">ptr</span>: <span style="color: #ce5c00; font-weight: bold">*</span><span style="color: #204a87; font-weight: bold">mut</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Task</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span>-&gt; <span style="color: #000000">Self</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #3465a4">Self</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">Rc</span>::<span style="color: #000000">from_raw</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">ptr</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">as</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">*</span><span style="color: #204a87; font-weight: bold">const</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Task</span><span style="color: #000000; font-weight: bold">))</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
</code></pre></div>

<h3 id="runtime-references">Runtime references</h3>
<p>In the function <code>wake_by_ref</code> above, our task needs to reach out into the runtime and mark itself as
ready. This implies that each <code>TaskRef</code> needs to hold a reference to the runtime, which is the main
motivation for the <code>Runtime</code> struct to be a thin wrapper around a reference-counted <code>RuntimeInner</code>.</p>
<aside>
<p>This is a self-inflicted limitation by taking the easiest option of using a task reference as a
waker. It should be perfectly possible to remove the <code>Rc</code> (and hence a layer of indirection) and use
a type for the waker that can access the runtime through a different way, for example through a
shared <code>Pin&lt;&amp;'static Runtime&gt;</code>.</p>
<p>This kind of optimisation could only be sound in this specific domain, where game logic is only
running on the main thread, and the <code>'static</code> lifetime can be repurposed to mean "as long as the
game instance is running" instead of the entire program.</p>
<p>I already do this with the <a href="https://github.com/DomWilliams0/name-needed/blob/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/simulation.rs#L139-L149">game world
instance</a>,
because it can be assumed that any code running within the context of the world has an active
instance, and is therefore safe to access.</p>
<p>Probably not a very important optimisation to bother with here, but then again half of the purpose
of this project is to enjoy going low-level for the fun of it :^)</p>
</aside>
<p>Another key aspect of the <code>Runtime</code> type is that it holds the inner type in a
<a href="https://doc.rust-lang.org/core/cell/struct.RefCell.html"><code>RefCell</code></a>. This allows for juggling
Rust's strict rules of aliasing XOR mutability at runtime, which is needed when polling ready
futures.</p>
<p>We need to iterate the ready queue while simultaneously appending to it, which requires both
aliasing (iteration) and mutability (appending). Without a <code>RefCell</code> it wouldn't compile, and with
it we get a panic:</p>
<div class="code" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>thread &#39;main&#39; panicked at &#39;already mutably borrowed: BorrowError
   3: std::panicking::begin_panic_handler::{{closure}}
      ...
   8: core::result::Result&lt;T,E&gt;::expect
   9: core::cell::RefCell&lt;T&gt;::borrow
      ...
<span style="background-color: #ffffcc">  12: simulation::runtime::runtime::Runtime::mark_ready    &lt;---- adding to ready queue
</span><span style="background-color: #ffffcc">  13: &lt;simulation::runtime::runtime::TaskRef as cooked_waker::WakeRef&gt;::wake_by_ref
</span>  14: &lt;T as cooked_waker::IntoWaker&gt;::VTABLE::{{closure}}
  15: core::ops::function::FnOnce::call_once
<span style="background-color: #ffffcc">  16: core::task::wake::Waker::wake_by_ref
</span>  17: &lt;simulation::TimerFuture as core::future::future::Future&gt;::poll
<span style="background-color: #ffffcc">  18: &lt;simulation::WanderActivity as simulation::Activity&gt;::dew_it::{{closure}}
</span>  19: &lt;core::future::from_generator::GenFuture&lt;T&gt; as core::future::future::Future&gt;::poll
  20: &lt;core::pin::Pin&lt;P&gt; as core::future::future::Future&gt;::poll
  21: &lt;simulation::activity::system::ActivitySystem as shred::system::System&gt;::run::{{closure}}
  22: &lt;core::future::from_generator::GenFuture&lt;T&gt; as core::future::future::Future&gt;::poll
<span style="background-color: #ffffcc">  23: simulation::runtime::runtime::TaskRef::poll_task
</span><span style="background-color: #ffffcc">  24: simulation::runtime::runtime::Runtime::tick          &lt;---- iterating ready queue
</span>      ...
</code></pre></div>

<p>We can see from the backtrace that a <code>TimerFuture</code> is waking up during the poll, and is unable to
take a second mutable reference to the runtime.</p>
<p>The workaround here is to move the ready queue out of the runtime in order to drop the mutable
reference:</p>
<div class="code" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #8f5902; font-style: italic">// simplified</span>
<span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Runtime</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">pub</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">tick</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #204a87; font-weight: bold">let</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">mut</span><span style="color: #f8f8f8"> </span><span style="color: #000000">ready_tasks</span>: <span style="color: #204a87">Vec</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">WeakTaskRef</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #8f5902; font-style: italic">// take a mutable reference to RuntimeInner</span>
<span style="color: #f8f8f8">            </span><span style="color: #204a87; font-weight: bold">let</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">mut</span><span style="color: #f8f8f8"> </span><span style="color: #000000">inner</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #0000cf; font-weight: bold">0.</span><span style="color: #000000">borrow_mut</span><span style="color: #000000; font-weight: bold">();</span><span style="color: #f8f8f8"></span>

<span style="color: #f8f8f8">            </span><span style="color: #8f5902; font-style: italic">// move ready tasks out of runtime so we can</span>
<span style="color: #f8f8f8">            </span><span style="color: #8f5902; font-style: italic">// release the mutable ref</span>
<span style="color: #f8f8f8">            </span><span style="color: #000000">std</span>::<span style="color: #000000">mem</span>::<span style="color: #000000">take</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #204a87; font-weight: bold">mut</span><span style="color: #f8f8f8"> </span><span style="color: #000000">inner</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">ready</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"></span>

<span style="color: #f8f8f8">            </span><span style="color: #8f5902; font-style: italic">// mutable reference is dropped here</span>
<span style="color: #f8f8f8">        </span><span style="color: #000000; font-weight: bold">};</span><span style="color: #f8f8f8"></span>

<span style="color: #f8f8f8">        </span><span style="color: #8f5902; font-style: italic">// the ready queue is now empty</span>

<span style="color: #f8f8f8">        </span><span style="color: #8f5902; font-style: italic">// poll tasks in ready queue, which could invoke</span>
<span style="color: #f8f8f8">        </span><span style="color: #8f5902; font-style: italic">// `wake_by_ref` on the Waker and push themselves</span>
<span style="color: #f8f8f8">        </span><span style="color: #8f5902; font-style: italic">// back onto the ready queue</span>
<span style="color: #f8f8f8">        </span><span style="color: #204a87; font-weight: bold">for</span><span style="color: #f8f8f8"> </span><span style="color: #000000">task</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">in</span><span style="color: #f8f8f8"> </span><span style="color: #000000">ready_tasks</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">drain</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">..</span><span style="color: #000000; font-weight: bold">).</span><span style="color: #000000">filter_map</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">|</span><span style="color: #000000">t</span><span style="color: #ce5c00; font-weight: bold">|</span><span style="color: #f8f8f8"> </span><span style="color: #000000">t</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">upgrade</span><span style="color: #000000; font-weight: bold">())</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #000000">task</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">poll_task</span><span style="color: #000000; font-weight: bold">();</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
</code></pre></div>

<p>The actual code is <a href="https://github.com/DomWilliams0/name-needed/blob/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/runtime/runtime.rs#L111-L139">more efficient with
allocations</a>,
but implements the same concept.</p>
<h1 id="using-the-runtime">Using the runtime</h1>
<p>Now that we've seen how the runtime works, let's look into how it's used.</p>
<p>To avoid things staying too abstract, we'll use the wander behaviour <a href="/devlog6">from the last
devlog</a> as a concrete example, whose implementation is conveniently short.</p>
<div class="code" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #8f5902; font-style: italic">// pseudo-code</span>
<span style="color: #204a87; font-weight: bold">async</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">wander_activity</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">ctx</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span>-&gt; <span style="color: #204a87">Result</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000; font-weight: bold">(),</span><span style="color: #f8f8f8"> </span><span style="color: #000000">_</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">loop</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #8f5902; font-style: italic">// walk to a nearby position</span>
<span style="color: #f8f8f8">        </span><span style="color: #204a87; font-weight: bold">let</span><span style="color: #f8f8f8"> </span><span style="color: #000000">pos</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">choose_wander_destination</span><span style="color: #000000; font-weight: bold">();</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #000000">ctx</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">go_to</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">pos</span><span style="color: #000000; font-weight: bold">).</span><span style="color: #204a87; font-weight: bold">await</span><span style="color: #ce5c00; font-weight: bold">?</span><span style="color: #000000; font-weight: bold">;</span><span style="color: #f8f8f8"></span>

<span style="color: #f8f8f8">        </span><span style="color: #8f5902; font-style: italic">// loiter for a few ticks</span>
<span style="color: #f8f8f8">        </span><span style="color: #000000">ctx</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">wait</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #0000cf; font-weight: bold">3</span><span style="color: #000000; font-weight: bold">).</span><span style="color: #204a87; font-weight: bold">await</span><span style="color: #000000; font-weight: bold">;</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
</code></pre></div>

<p>This shows use of events, timers and the handling of interruptions (or rather how we get it for
free).</p>
<h2 id="events">Events</h2>
<p>When we see <code>ctx.goto(pos).await</code> above, it's instantiating a <code>GoToSubactivity</code>, which is a
self-contained unit of behaviour (and an implementor of <code>Future</code>). What it does is as follows:</p>
<ul>
<li>Post a new destination request to the navigation system</li>
<li>Subscribe to <code>Arrived(Result&lt;_, _&gt;)</code> events where the subject of the event is this agent<ul>
<li>This will either contain <code>Ok(_)</code> if the agent arrives successfully, or some <code>Err(_)</code> if
    something went wrong</li>
</ul>
</li>
<li>Wait as many game ticks as necessary until the event arrives<ul>
<li>This is where the <code>async</code> magic happens</li>
</ul>
</li>
<li>Unsubscribe from any more arrival events, extract the <code>Result</code> from the received event and return back up to the calling activity</li>
</ul>
<p>A major convenience here is how the <code>async</code> function <code>go_to</code> hides all details of the
implementation, including the fact that it may take place over many game ticks. The caller does not
need to concern itself with event subscriptions either.</p>
<aside>
<p>Sometimes an activity <em>does</em> need to receive events, particularly those that are concerned with a
target entity such as the "go to and pick up this item" behaviour.</p>
<p>The target might be destroyed, picked up or otherwise made unavailable during navigation to it, but
we don't want to have to wait until we get there to abort.</p>
<p>Conveniently, an activity can also subscribe to events outside of a nested subactivity, and receive
them in a callback
<a href="https://github.com/DomWilliams0/name-needed/blob/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/activity/activity/go_haul.rs#L95-L103"><code>on_unhandled_event</code></a>
where it can decide whether to abort the entire activity.</p>
</aside>
<p>The key part here is how we wait for an event, and get woken up by the runtime when an appropriate one
arrives.</p>
<div class="code" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">ActivityContext</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">  </span><span style="color: #8f5902; font-style: italic">/// Waits until the next event matching this agent&#39;s</span>
<span style="color: #f8f8f8">  </span><span style="color: #8f5902; font-style: italic">/// subscription arrives</span>
<span style="color: #f8f8f8">  </span><span style="color: #204a87; font-weight: bold">async</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">next_event</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span>-&gt; <span style="color: #000000">EntityEvent</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #204a87; font-weight: bold">loop</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #204a87; font-weight: bold">match</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">task</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">pop_event</span><span style="color: #000000; font-weight: bold">()</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">                </span><span style="color: #204a87">None</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">                    </span><span style="color: #8f5902; font-style: italic">// keep waiting until an event marks</span>
<span style="color: #f8f8f8">                    </span><span style="color: #8f5902; font-style: italic">// this task as ready again</span>
<span style="color: #f8f8f8">                    </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">task</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">park_until_triggered</span><span style="color: #000000; font-weight: bold">().</span><span style="color: #204a87; font-weight: bold">await</span><span style="color: #000000; font-weight: bold">;</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">                </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">                </span><span style="color: #204a87">Some</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">evt</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">return</span><span style="color: #f8f8f8"> </span><span style="color: #000000">evt</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">TaskRef</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #8f5902; font-style: italic">/// Returns Some(evt) if one is waiting, otherwise</span>
<span style="color: #f8f8f8">    </span><span style="color: #8f5902; font-style: italic">/// None. Does not block</span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">pub</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">pop_event</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span>-&gt; <span style="color: #204a87">Option</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">EntityEvent</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #8f5902; font-style: italic">/// self.0.event_sink is a RefCell&lt;VecDeque&lt;EntityEvent&gt;&gt;</span>
<span style="color: #f8f8f8">        </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #0000cf; font-weight: bold">0.</span><span style="color: #000000">event_sink</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">borrow_mut</span><span style="color: #000000; font-weight: bold">().</span><span style="color: #000000">pop_front</span><span style="color: #000000; font-weight: bold">()</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
</code></pre></div>

<p>In
<a href="https://github.com/DomWilliams0/name-needed/blob/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/activity/context.rs#L310-L329"><code>next_event</code></a>,
we sit in a loop popping events from the task's event queue. Note that <code>pop_event</code> is not async, and
returns without blocking.</p>
<p>If there is an event in the queue then
<code>next_event</code> returns immediately, otherwise it calls <code>task.park_until_triggered</code>. This uses a slightly unusual future that intentionally does not use the waker passed to it:</p>
<div class="code" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #204a87; font-weight: bold">pub</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">struct</span> <span style="color: #000000">ParkUntilWakeupFuture</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">ParkState</span><span style="color: #000000; font-weight: bold">);</span><span style="color: #f8f8f8"></span>

<span style="color: #8f5902; font-style: italic">#[derive(Copy, Clone)]</span><span style="color: #f8f8f8"></span>
<span style="color: #204a87; font-weight: bold">enum</span> <span style="color: #000000">ParkState</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">Unpolled</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">Parked</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000">Complete</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Future</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">for</span><span style="color: #f8f8f8"> </span><span style="color: #000000">ParkUntilWakeupFuture</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">type</span> <span style="color: #000000">Output</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">();</span><span style="color: #f8f8f8"></span>

<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">poll</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #204a87; font-weight: bold">mut</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">self</span>: <span style="color: #000000">Pin</span><span style="color: #ce5c00; font-weight: bold">&lt;&amp;</span><span style="color: #204a87; font-weight: bold">mut</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">Self</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #000000">_</span>: <span style="color: #204a87; font-weight: bold">&amp;</span><span style="color: #000000">mut</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Context</span><span style="color: #ce5c00; font-weight: bold">&lt;&#39;</span><span style="color: #204a87">_</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span>-&gt; <span style="color: #000000">Poll</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #3465a4">Self</span>::<span style="color: #000000">Output</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #204a87; font-weight: bold">match</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #0000cf; font-weight: bold">0</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #000000">ParkState</span>::<span style="color: #000000">Unpolled</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">                </span><span style="color: #8f5902; font-style: italic">// first call</span>
<span style="color: #f8f8f8">                </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #0000cf; font-weight: bold">0</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">ParkState</span>::<span style="color: #000000">Parked</span><span style="color: #000000; font-weight: bold">;</span><span style="color: #f8f8f8"></span>

<span style="color: #f8f8f8">                </span><span style="color: #8f5902; font-style: italic">// intentionally does use waker, the runtime</span>
<span style="color: #f8f8f8">                </span><span style="color: #8f5902; font-style: italic">// will wake us up</span>
<span style="color: #f8f8f8">                </span><span style="color: #000000">Poll</span>::<span style="color: #000000">Pending</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #000000">ParkState</span>::<span style="color: #000000">Parked</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">                </span><span style="color: #8f5902; font-style: italic">// must have been woken up by the runtime</span>
<span style="color: #f8f8f8">                </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #0000cf; font-weight: bold">0</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">ParkState</span>::<span style="color: #000000">Complete</span><span style="color: #000000; font-weight: bold">;</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">                </span><span style="color: #000000">Poll</span>::<span style="color: #000000">Ready</span><span style="color: #000000; font-weight: bold">(())</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #000000">ParkState</span>::<span style="color: #000000">Complete</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #000000">unreachable!</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #4e9a06">&quot;task has already been unparked&quot;</span><span style="color: #000000; font-weight: bold">),</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
</code></pre></div>

<p>When this future is <code>await</code>'d on, it is effectively doomed forever and can never again make progress -
unless there's a mechanism in the runtime to mark the task as ready, such as the arrival of an
event!</p>
<p>So back to the context of the wandering behaviour; we have subscribed the agent to the <code>Arrived</code>
event and parked ourselves indefinitely. At some point later this event might arrive and get pushed
onto the task's event queue, the task marked as ready by the runtime, and the result passed up to the
subactivity.</p>
<p>Let's assume it was a successful arrival for now, so it's time to loiter for a few moments at our
new destination.</p>
<h2 id="timers">Timers</h2>
<p>Loitering, also known as standing still doing nothing, is implemented with <code>ctx.wait(n).await</code>,
where <code>n</code> is the number of game ticks to wait.</p>
<p>The implementation of timers is out of the scope of this post, but the idea is that we
submit a weak task reference and the number of ticks to sleep, and we get back an opaque token that
represents our timer instance. The token can be used for cancellation.</p>
<div class="code" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">ActivityContext</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">pub</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">wait</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #ce5c00; font-weight: bold">&amp;</span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #000000">ticks</span>: <span style="color: #204a87; font-weight: bold">u32</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span>-&gt; <span style="color: #000000">TimerFuture</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #204a87; font-weight: bold">let</span><span style="color: #f8f8f8"> </span><span style="color: #000000">timers</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">world</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">resource_mut</span>::<span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #000000">RuntimeTimers</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">();</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #204a87; font-weight: bold">let</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">end_tick</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #000000">token</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000">timers</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">schedule</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">ticks</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">task</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">weak</span><span style="color: #000000; font-weight: bold">());</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #000000">TimerFuture</span>::<span style="color: #000000">new</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #000000">end_tick</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #000000">token</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">world</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span><span style="color: #8f5902; font-style: italic">// world ref is used later</span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>

<span style="color: #204a87; font-weight: bold">impl</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Future</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">for</span><span style="color: #f8f8f8"> </span><span style="color: #000000">TimerFuture</span><span style="color: #ce5c00; font-weight: bold">&lt;&#39;</span><span style="color: #204a87">_</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">type</span> <span style="color: #000000">Output</span><span style="color: #f8f8f8"> </span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">();</span><span style="color: #f8f8f8"></span>

<span style="color: #f8f8f8">    </span><span style="color: #204a87; font-weight: bold">fn</span> <span style="color: #000000">poll</span><span style="color: #000000; font-weight: bold">(</span><span style="color: #3465a4">self</span>: <span style="color: #000000">Pin</span><span style="color: #ce5c00; font-weight: bold">&lt;&amp;</span><span style="color: #204a87; font-weight: bold">mut</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">Self</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">,</span><span style="color: #f8f8f8"> </span><span style="color: #000000">cx</span>: <span style="color: #204a87; font-weight: bold">&amp;</span><span style="color: #000000">mut</span><span style="color: #f8f8f8"> </span><span style="color: #000000">Context</span><span style="color: #ce5c00; font-weight: bold">&lt;&#39;</span><span style="color: #204a87">_</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #000000; font-weight: bold">)</span><span style="color: #f8f8f8"> </span>-&gt; <span style="color: #000000">Poll</span><span style="color: #ce5c00; font-weight: bold">&lt;</span><span style="color: #3465a4">Self</span>::<span style="color: #000000">Output</span><span style="color: #ce5c00; font-weight: bold">&gt;</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #204a87; font-weight: bold">if</span><span style="color: #f8f8f8"> </span><span style="color: #3465a4">self</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">elapsed</span><span style="color: #000000; font-weight: bold">()</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #000000">cx</span><span style="color: #000000; font-weight: bold">.</span><span style="color: #000000">waker</span><span style="color: #000000; font-weight: bold">().</span><span style="color: #000000">wake_by_ref</span><span style="color: #000000; font-weight: bold">();</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #000000">Poll</span>::<span style="color: #000000">Ready</span><span style="color: #000000; font-weight: bold">(())</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"> </span><span style="color: #204a87; font-weight: bold">else</span><span style="color: #f8f8f8"> </span><span style="color: #000000; font-weight: bold">{</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">            </span><span style="color: #000000">Poll</span>::<span style="color: #000000">Pending</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">        </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #f8f8f8">    </span><span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
<span style="color: #000000; font-weight: bold">}</span><span style="color: #f8f8f8"></span>
</code></pre></div>

<p>There's nothing really too complicated in the <code>Future</code> implementation, just an elapsed check and
call to the waker as all normal futures should. It's rather in the <code>Drop</code> implementation where
things get exciting.</p>
<h2 id="interruptions">Interruptions</h2>
<p>An activity doesn't always finish gracefully, either due to a more urgent behaviour preempting the
current or a subactivity like goto failing. Switching to a new activity causes the old one to be dropped
along with all its state.</p>
<p>We can use the destructor of a <code>Future</code> implementor to neatly clean up following an ungraceful cancellation - let's see how the futures used in wandering make the most of this.</p>
<ul>
<li>
<p><a href="https://github.com/DomWilliams0/name-needed/blob/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/activity/subactivity/go_to.rs#L94-L101"><strong>Navigating to a
    destination</strong></a>:
    if the <code>GotoSubactivity</code> future is dropped before it receives an <code>Arrived</code> event and terminates
    normally, we can send a request to the navigation system to
    cancel the current journey.</p>
</li>
<li>
<p><a href="https://github.com/DomWilliams0/name-needed/blob/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/runtime/futures.rs#L66-L79"><strong>Waiting for a
    timer</strong></a>:
    if a <code>TimerFuture</code> is dropped before the timer elapses, the timer can be cancelled in the
    destructor.</p>
</li>
</ul>
<p>Compare this to the <a href="https://github.com/DomWilliams0/name-needed/blob/2431395fc022a500bcfd19c5c97bde7d4bc9e53a/game/simulation/src/activity/activities/wander.rs#L145-L151">old wander
implementation</a>,
where the loiter timer had to manually clear the path AND cancel the timer in its <code>on_finish</code> method
- a terrible substitute for a destructor.</p>
<h1 id="conclusion">Conclusion</h1>
<p>We've seen what makes up a runtime, how tasks are allocated, used and interrupted, and how they are
used to implement behaviours. I hope this breakdown helps others to make use of Rust's fantastic
async features in their own games and engines.</p>
<p>If you'd like to see how activities more complex than wandering make use of subactivities, have a
look at:</p>
<ul>
<li><a href="https://github.com/DomWilliams0/name-needed/tree/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/activity/subactivity">All subactivities</a>,
    such as "eat", "break block" and "haul"</li>
<li><a href="https://github.com/DomWilliams0/name-needed/tree/41a9c1844db7745ef1ee815a7705bf5747ef7f86/game/simulation/src/activity/activity">All activities</a>,
    which make use of subactivities</li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This is the same concept as in <a href="/devlog4#activity-lifecycle">devlog 4</a>, except now we make use
of Rust's future types for ready/pending instead of manually implementing the active/blocked
lifecycle. The reasons for doing so are documented in <a href="/devlog6">devlog 6</a>.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>I found while writing this post that the runtime was in fact <a href="https://github.com/DomWilliams0/name-needed/commit/b55479fbcb753a6b77308c8395e3092ad01ff5c5">holding strong task
  references</a>.
  Thank you for being a rubber duck!&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
    </article>
</main>

<footer>
    <div class="prev-next">
    <span><a href="/devlog6">‚Üê Devlog #6: async activities</a></span>
    <span class="next"><a href="/minecraft-fs">A FUSE filesystem for Minecraft ‚Üí</a></span>
</div>

    <hr/> <br/>
    <p>Return to <a href="/">home</a> | Subscribe to <a href="/index.xml">RSS</a> | Send me an <a href="mailto:contact@domwillia.ms">email</a> | Follow me on <a href="https://github.com/DomWilliams0">GitHub</a></p>
</footer>
</body>
</html>

